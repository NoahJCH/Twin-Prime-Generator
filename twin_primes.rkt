#lang lazy

(define (output n s) ;choose -1 for infinite output
  (cond
    [(empty? s) (void)]
    [(= 0 n) (void)]
    [true
     (display (car s))
     (newline)
     (output (sub1 n) (cdr s))]))



(define (wheel lst n)
  (if (empty? lst) (wheelcaller n)
      (if (and (MR-test (+ n (car lst))) (MR-test (+ 2 n (car lst))))
          (cons (list (+ n (car lst)) (+ 2 n (car lst))) (wheel (cdr lst) n))
          (wheel (cdr lst) n))))
      ;(wheel-help (+ n (car lst)) (+ 2 n (car lst)) lst n)))

;(define (wheel-help lower upper lst n)
 ; (if (and (MR-test lower) (MR-test upper))
  ;    (cons (list lower upper) (wheel (cdr lst) n))
   ;   (wheel (cdr lst) n)))

(define (wheelcaller n)
  (wheel '(17   29   41   59   71   101   107   137   149   179   191   197   227   239   269   281   311   347   359   389   419   431   437   461   491   521   527   569   587   599   617   629   641   659   701   731   797   809   821   827   839   851   857   881   899   941   989   1007   1019   1031   1037   1049   1061   1091   1121   1151   1187   1217   1229   1247   1271   1277   1289   1301   1319   1361   1367   1409   1427   1451   1457   1481   1487   1499   1511   1541   1577   1607   1619   1667   1679   1691   1697   1709   1721   1739   1751   1787   1817   1829   1847   1871   1877   1889   1907   1919   1931   1949   1997   2027   2069   2081   2087   2111   2129   2141   2159   2201   2207   2237   2267   2279   2291   2309   2339   2369   2381   2411   2417   2447   2459   2477   2489   2501   2531   2537   2549   2579   2591   2621   2657   2669   2687   2699   2711   2729   2747   2771   2789   2801   2831   2837   2867   2879   2909   2921   2927   2939   2969   2999   3011   3041   3077   3119   3137   3149   3161   3167   3191   3251   3257   3299   3317   3329   3347   3359   3371   3389   3401   3431   3461   3467   3527   3539   3557   3569   3581   3587   3611   3629   3671   3719   3737   3761   3767   3779   3791   3797   3821   3851   3917   3929   3959   3977   4001   4007   4019   4031   4049   4061   4091   4097   4127   4139   4157   4181   4187   4217   4229   4241   4259   4271   4307   4337   4349   4391   4397   4421   4427   4439   4451   4469   4481   4517   4547   4559   4577   4601   4619   4637   4649   4661   4679   4721   4727   4757   4787   4799   4811   4817   4841   4859   4889   4931   4967   4997   5009   5021   5039   5051   5099   5111   5141   5147   5177   5189   5207   5219   5231   5249   5261   5279   5309   5321   5351   5387   5417   5429   5441   5459   5477   5501   5519   5561   5567   5609   5639   5651   5657   5669   5699   5711   5741   5771   5777   5807   5849   5867   5879   5891   5897   5909   5921   5981   5987   6029   6047   6077   6089   6101   6107   6119   6131   6161   6197   6239   6269   6287   6299   6311   6317   6341   6359   6371   6401   6437   6449   6467   6491   6497   6509   6527   6551   6569   6581   6647   6659   6689   6701   6707   6731   6737   6749   6761   6779   6791   6821   6827   6857   6869   6887   6899   6911   6947   6959   6971   6989   7001   7037   7067   7079   7097   7121   7127   7151   7157   7169   7199   7211   7277   7289   7307   7331   7349   7361   7367   7391   7409   7451   7457   7487   7517   7529   7541   7547   7559   7571   7589   7619   7661   7697   7727   7739   7751   7757   7769   7781   7829   7871   7877   7919   7937   7949   7961   7979   7991   8009   8051   8081   8087   8117   8147   8159   8189   8207   8219   8231   8249   8291   8297   8339   8381   8387   8399   8417   8429   8441   8471   8507   8537   8549   8579   8597   8609   8621   8627   8639   8651   8681   8711   8717   8759   8777   8807   8819   8837   8849   8861   8891   8927   8969   8999   9011   9017   9041   9047   9071   9089   9101   9131   9167   9179   9197   9209   9221   9239   9257   9281   9299   9311   9341   9377   9389   9407   9419   9431   9437   9461   9467   9479   9509   9521   9551   9587   9599   9617   9629   9641   9671   9677   9701   9719   9731   9767   9797   9809   9827   9851   9857   9869   9881   9899   9929   9941   10007   10037   10061   10067   10079   10091   10097   10121   10139   10181   10187   10247   10259   10271   10277   10289   10301   10319   10331   10391   10397   10427   10457   10469   10487   10499   10511   10529   10559   10601   10607   10649   10667   10691   10709   10721   10727   10739   10781   10817   10847   10859   10889   10919   10937   10949   10961   10979   10991   11021   11027   11057   11069   11111   11117   11129   11147   11159   11171   11189   11201   11237   11267   11279   11309   11327   11351   11357   11369   11381   11411   11441   11447   11489   11507   11519   11549   11567   11579   11591   11621   11651   11657   11699   11717   11729   11741   11747   11771   11777   11819   11831   11861   11897   11909   11927   11939   11951   11969   11981   11987   12011   12029   12041   12071   12107   12119   12137   12149   12161   12167   12191   12209   12239   12251   12281   12317   12347   12359   12371   12377   12401   12407   12431   12449   12497   12539   12557   12581   12587   12599   12611   12629   12641   12671   12707   12737   12767   12797   12809   12821   12827   12839   12851   12869   12911   12917   12977   13001   13007   13019   13031   13049   13061   13127   13157   13199   13217   13229   13241   13259   13289   13301   13331   13337   13367   13379   13397   13421   13439   13457   13469   13499   13511   13547   13577   13589   13619   13631   13667   13679   13691   13709   13721   13751   13757   13787   13799   13829   13841   13859   13877   13889   13901   13919   13931   13961   13967   13997   14009   14039   14057   14081   14087   14099   14141   14171   14219   14237   14249   14279   14291   14297   14321   14351   14381   14387   14429   14447   14459   14471   14477   14489   14501   14549   14561   14591   14627   14657   14669   14681   14687   14699   14711   14717   14741   14759   14801   14849   14867   14879   14891   14897   14921   14939   14951   14981   15011   15017   15047   15077   15089   15107   15131   15137   15149   15161   15179   15227   15269   15287   15311   15317   15329   15341   15347   15359   15371   15401   15437   15467   15479   15527   15539   15551   15557   15569   15581   15599   15641   15647   15677   15707   15731   15737   15749   15779   15791   15809   15857   15887   15929   15941   15947   15971   15989   16019   16031   16061   16067   16097   16109   16127   16139   16151   16169   16187   16199   16229   16241   16271   16277   16307   16319   16337   16349   16361   16397   16409   16439   16451   16481   16517   16529   16559   16571   16589   16607   16631   16649   16661   16691   16697   16727   16739   16769   16787   16799   16811   16829   16871   16901   16967   16979   16997   17009   17021   17027   17051   17111   17117   17159   17177   17189   17201   17207   17219   17231   17261   17291   17321   17357   17387   17399   17417   17429   17441   17447   17471   17489   17531   17579   17597   17621   17627   17651   17657   17669   17681   17711   17747   17777   17789   17819   17837   17861   17867   17879   17891   17909   17921   17957   17987   17999   18017   18041   18047   18059   18077   18089   18101   18119   18131   18167   18197   18209   18251   18257   18281   18287   18299   18311   18329   18371   18377   18407   18437   18449   18461   18479   18509   18521   18539   18581   18587   18617   18647   18659   18671   18677   18701   18719   18749   18761   18791   18827   18839   18857   18869   18881   18899   18911   18917   18959   18971   19001   19007   19037   19049   19067   19079   19091   19109   19139   19169   19181   19211   19247   19289   19301   19307   19319   19337   19361   19379   19421   19427   19469   19499   19517   19529   19541   19559   19571   19601   19631   19637   19697   19709   19727   19739   19751   19757   19769   19781   19841   19847   19889   19907   19931   19937   19949   19961   19967   19991   20021   20087   20099   20129   20147   20159   20171   20177   20201   20219   20231   20261   20297   20309   20327   20351   20357   20387   20399   20411   20429   20441   20477   20507   20519   20549   20561   20567   20591   20597   20609   20621   20639   20651   20687   20717   20729   20747   20771   20789   20807   20819   20831   20849   20861   20897   20927   20939   20957   20981   20987   21011   21017   21029   21059   21101   21137   21167   21179   21191   21209   21221   21251   21269   21311   21317   21347   21377   21389   21401   21407   21419   21431   21449   21479   21491   21521   21557   21587   21599   21611   21629   21641   21647   21689   21731   21737   21779   21797   21809   21821   21839   21869   21881   21911   21941   21947   21977   22019   22037   22049   22067   22079   22091   22109   22151   22157   22199   22247   22259   22271   22277   22289   22301   22331   22367   22409   22439   22457   22469   22481   22487   22499   22511   22541   22571   22577   22619   22637   22661   22667   22679   22697   22721   22739   22751   22817   22829   22859   22871   22877   22901   22907   22931   22949   22961   22991   23027   23039   23057   23069   23081   23117   23129   23141   23159   23171   23201   23207   23237   23249   23267   23279   23291   23297   23321   23327   23339   23369   23381   23447   23459   23477   23501   23519   23531   23537   23561   23579   23591   23627   23657   23669   23687   23711   23717   23729   23741   23759   23789   23831   23867   23897   23909   23921   23927   23939   23951   23981   23999   24041   24047   24107   24119   24131   24137   24149   24161   24179   24221   24251   24257   24287   24317   24329   24359   24371   24377   24389   24419   24461   24467   24509   24527   24551   24569   24587   24599   24611   24641   24677   24707   24719   24749   24767   24779   24797   24809   24821   24839   24851   24881   24887   24917   24929   24977   24989   25007   25019   25031   25061   25097   25139   25169   25187   25211   25217   25229   25241   25271   25301   25307   25349   25367   25379   25391   25409   25427   25451   25469   25481   25511   25547   25559   25577   25589   25601   25607   25631   25637   25679   25691   25721   25757   25769   25787   25799   25811   25841   25847   25871   25889   25901   25931   25937   25967   25979   25997   26009   26021   26027   26051   26069   26099   26111   26177   26207   26231   26237   26249   26261   26267   26291   26309   26357   26399   26417   26441   26447   26459   26471   26489   26501   26561   26567   26597   26627   26639   26657   26669   26681   26699   26711   26729   26771   26777   26837   26861   26867   26879   26891   26909   26951   26987   27017   27029   27059   27089   27101   27107   27119   27149   27161   27191   27197   27227   27239   27257   27281   27299   27317   27329   27341   27359   27371   27407   27437   27449   27479   27491   27497   27527   27539   27551   27569   27581   27611   27617   27647   27659   27689   27719   27737   27749   27761   27791   27821   27827   27869   27887   27899   27917   27941   27947   27959   28001   28031   28079   28097   28109   28121   28139   28151   28157   28181   28199   28211   28241   28277   28289   28307   28319   28331   28337   28349   28361   28409   28421   28451   28487   28517   28529   28541   28547   28571   28577   28601   28619   28661   28667   28709   28727   28739   28751   28757   28781   28799   28811   28841   28877   28907   28937   28967   28979   28991   28997   29009   29021   29039   29087   29129   29147   29171   29177   29189   29201   29207   29219   29231   29297   29327   29369   29387   29399   29411   29429   29441   29459   29501   29507   29537   29567   29591   29597   29609   29639   29669   29681   29717   29747   29759   29789   29801   29831   29837   29849   29879   29891   29921   29927   29957   29969   29987   29999   30011   30029) (+ 30030 n)))


(define twinprimes
  (cons (list 3 5) (cons (list 5 7) (cons (list 11 13) (wheelcaller  -30030 )))))



;;call it with n and 0
(define (get-d-and-r d r)
  (if (= 0 (remainder d 2))
      (get-d-and-r (/ d 2) (+ r 1))
      (list d r)))

(define (call-m-test n)
  (m-test n (get-d-and-r  (- n 1)  0)))

(define (m-test n dr)
  (cond
    [(not (m-test-helper 9332593 n dr)) #f]
    [(not (m-test-helper 2 n dr)) #f]
    ;[(not (m-test-helper 2 n dr)) #f]
    [else #t]))

(define (m-test-helper a n dr)
  (miller-test a n dr (mod-power (remainder a n) (car dr) n 1)))

(define (miller-test a n dr result)
  (cond
    [(= 0 result) #t]
    [(= 1 result) #t]
    [(= (- n 1) result) #t]
    [else (r-loop (car dr) result n (- n 1))]))

(define (r-loop d result n end)
  (if (= d end) #f
      (cond
       ; [(= 1 result) #t]
        [(= end result) #t]
        [else (r-loop (* 2 d) (remainder (* result result) n) n end)]))) 

;; originaly call with (remainder base mod) r mod 1
(define (mod-power base pow mod result)
  (if (> pow 0)
      (if (= 1 (remainder pow 2))
          (mod-power (remainder (* base base) mod) (quotient pow 2) mod (remainder (* result base) mod))
          (mod-power (remainder (* base base) mod) (/ pow 2) mod result))
      result))

(define (smalltest n)
  (cond
    [(= n 2) #t]
[(= n 3) #t]
[(= n 5) #t]
[(= n 7) #t]
[(= n 11) #t]
[(= n 13) #t]
[(= n 17) #t]
[(= n 19) #t]
[(= n 23) #t]
[(= n 29) #t]
[(= n 31) #t]
[(= n 37) #t]
[(= n 41) #t]
[(= n 43) #t]
[(= n 47) #t]
[(= n 53) #t]
;[(= n 59) #t]
;[(= n 61) #t]
;[(= n 67) #t]
    [else #f]))

;;299417 and 2


(define (MR-test n)
  (cond
    [(< n 54) (smalltest n)]
;    [(= 0 (remainder n 2)) #f]
;[(= 0 (remainder n 3)) #f]
;[(= 0 (remainder n 5)) #f]
;[(= 0 (remainder n 7)) #f]
;[(= 0 (remainder n 11)) #f]
;[(= 0 (remainder n 13)) #f]
[(= 0 (remainder n 17)) #f]
[(= 0 (remainder n 19)) #f]
[(= 0 (remainder n 23)) #f]
[(= 0 (remainder n 29)) #f]
[(= 0 (remainder n 31)) #f]
[(= 0 (remainder n 37)) #f]
[(= 0 (remainder n 41)) #f]
[(= 0 (remainder n 43)) #f]
[(= 0 (remainder n 47)) #f]
[(= 0 (remainder n 53)) #f]
;[(= 0 (remainder n 59)) #f]
;[(= 0 (remainder n 61)) #f]
;[(= 0 (remainder n 67)) #f]
    [(call-m-test n) #t] ;;was up to 41 before now it will be up to 19 up to 50 is 90k up to 53 is 96k up to 53 is 100k
    [else #f]))



